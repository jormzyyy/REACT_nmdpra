{% extends "reports/base.html" %}

{% block title %}Inventory Report - NMDPRA{% endblock %}

{% block content %}
<!-- Bootstrap CSS & JS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Flatpickr CSS & JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<!-- Flatpickr monthSelect plugin -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/index.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">

<!-- Tom Select CSS & JS -->
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

<div class="report-container">
    <!-- NMDPRA Logo for PDF/Print -->
    <div style="text-align:center; margin-bottom: 1.5rem;">
        <img src="{{ url_for('static', filename='images/logo/nmdpra-logo.png') }}" alt="NMDPRA Logo" style="max-height:80px;">
    </div>

    <h2 style="text-align:center;">Inventory Report</h2>
    <div style="text-align:center; margin-bottom: 1rem;">
        <strong>Period:</strong> {{ meta.start_date or '—' }} to {{ meta.end_date or '—' }}<br>
        <strong>Generated by:</strong> {{ meta.generated_by or '—' }}<br>
        <strong>Generated at:</strong> {{ meta.generated_at or '—' }}
    </div>

    <div class="d-flex gap-3 mb-4">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#monthlyModal">Monthly Report</button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#weeklyModal">Weekly Report</button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#dailyModal">Daily Report</button>
        
        <!-- Download Excel Button -->
        {% if report_data %}
        <a href="{{ url_for('reports.download_excel_report', report_id=report_id) }}" class="btn btn-success ms-auto">
            Download Excel
        </a>
        {% endif %}
    </div>

    <!-- Monthly Modal -->
    <div class="modal fade" id="monthlyModal" tabindex="-1" aria-labelledby="monthlyModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form method="post" action="{{ url_for('reports.inventory_report') }}">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="monthlyModalLabel">Generate Monthly Report</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="month" class="form-label">Month</label>
                            <input type="text" id="month" name="month" class="form-control" placeholder="Select month" required autocomplete="off">
                        </div>
                        <div class="mb-3">
                            <label for="category_id_month" class="form-label">Category</label>
                            <select id="category_id_month" name="category_id" class="form-select">
                                <option value="">All</option>
                                {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="item_id_month" class="form-label">Item</label>
                            <select id="item_id_month" name="item_id" class="form-select">
                                <option value="">All</option>
                                {% for item in items %}
                                    <option value="{{ item.id }}">{{ item.item_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="location_month" class="form-label">Location</label>
                            <select id="location_month" name="location" class="form-select">
                                <option value="">All</option>
                                {% for loc in locations %}
                                    <option value="{{ loc }}">{{ loc }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <input type="hidden" name="report_type" value="monthly">
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Generate Report</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Weekly Modal -->
    <div class="modal fade" id="weeklyModal" tabindex="-1" aria-labelledby="weeklyModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form method="post" action="{{ url_for('reports.inventory_report') }}">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="weeklyModalLabel">Generate Weekly Report</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="week_range" class="form-label">Date Range</label>
                            <input type="text" id="week_range" name="week_range" class="form-control" placeholder="Select week range" required autocomplete="off">
                        </div>
                        <div class="mb-3">
                            <label for="category_id_week" class="form-label">Category</label>
                            <select id="category_id_week" name="category_id" class="form-select">
                                <option value="">All</option>
                                {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="item_id_week" class="form-label">Item</label>
                            <select id="item_id_week" name="item_id" class="form-select">
                                <option value="">All</option>
                                {% for item in items %}
                                    <option value="{{ item.id }}">{{ item.item_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="location_week" class="form-label">Location</label>
                            <select id="location_week" name="location" class="form-select">
                                <option value="">All</option>
                                {% for loc in locations %}
                                    <option value="{{ loc }}">{{ loc }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <input type="hidden" name="report_type" value="weekly">
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Generate Report</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Daily Modal -->
    <div class="modal fade" id="dailyModal" tabindex="-1" aria-labelledby="dailyModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form method="post" action="{{ url_for('reports.inventory_report') }}">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="dailyModalLabel">Generate Daily Report</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="day_date" class="form-label">Date</label>
                            <input type="text" id="day_date" name="day_date" class="form-control" placeholder="Select date" required autocomplete="off">
                        </div>
                        <div class="mb-3">
                            <label for="category_id_day" class="form-label">Category</label>
                            <select id="category_id_day" name="category_id" class="form-select">
                                <option value="">All</option>
                                {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="item_id_day" class="form-label">Item</label>
                            <select id="item_id_day" name="item_id" class="form-select">
                                <option value="">All</option>
                                {% for item in items %}
                                    <option value="{{ item.id }}">{{ item.item_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="location_day" class="form-label">Location</label>
                            <select id="location_day" name="location" class="form-select">
                                <option value="">All</option>
                                {% for loc in locations %}
                                    <option value="{{ loc }}">{{ loc }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <input type="hidden" name="report_type" value="daily">
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Generate Report</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    {% if report_data %}
        {% for category, items in report_data.items() %}
            <h3 style="margin-top:2rem; font-weight:bold;">{{ category }}</h3>
            <div class="inventory-list">
                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Description</th>
                            <th>Opening Stock</th>
                            <th>Purchases</th>
                            <th>Adjustment</th>
                            <th>HQ Issue</th>
                            <th>Jabi Issue</th>
                            <th>Closing Stock</th>
                            <th>Unit Price (₦)</th>
                            <th>Total Value (₦)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in items %}
                        <tr>
                            <td>{{ row.item_name }}</td>
                            <td>{{ row.description or 'N/A' }}</td>
                            <td>{{ row.opening_stock }}</td>
                            <td>{{ row.purchases }}</td>
                            <td>{{ row.adjustments }}</td>
                            <td>{{ row.hq_issues }}</td>
                            <td>{{ row.jabi_issues }}</td>
                            <td>{{ row.closing_stock }}</td>
                            <td>{{ "{:,.2f}".format(row.unit_price|float) }}</td>
                            <td>{{ "{:,.2f}".format(row.total_value|float) }}</td>
                        </tr>
                        {% endfor %}
                        <!-- Category Totals Row -->
                        <tr style="font-weight:bold; background:#f8f9fa;">
                            <td colspan="2">Total for {{ category }}</td>
                            <td>{{ category_totals[category].opening_stock }}</td>
                            <td>{{ category_totals[category].purchases }}</td>
                            <td>{{ category_totals[category].adjustments }}</td>
                            <td>{{ category_totals[category].hq_issues }}</td>
                            <td>{{ category_totals[category].jabi_issues }}</td>
                            <td>{{ category_totals[category].closing_stock }}</td>
                            <td></td>
                            <td>{{ "{:,.2f}".format(category_totals[category].total_value|float) }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        {% endfor %}

        <!-- Grand Totals -->
        <div class="inventory-list" style="margin-top:2rem;">
            <table class="inventory-table">
                <thead>
                    <tr style="background:#e0e0e0;">
                        <th colspan="2">Grand Total</th>
                        <th>Opening Stock</th>
                        <th>Purchases</th>
                        <th>Adjustment</th>
                        <th>HQ Issue</th>
                        <th>Jabi Issue</th>
                        <th>Closing Stock</th>
                        <th></th>
                        <th>Total Value (₦)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="font-weight:bold;">
                        <td colspan="2"></td>
                        <td>{{ grand_totals.opening_stock }}</td>
                        <td>{{ grand_totals.purchases }}</td>
                        <td>{{ grand_totals.adjustments }}</td>
                        <td>{{ grand_totals.hq_issues }}</td>
                        <td>{{ grand_totals.jabi_issues }}</td>
                        <td>{{ grand_totals.closing_stock }}</td>
                        <td></td>
                        <td>{{ "{:,.2f}".format(grand_totals.total_value|float) }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    {% endif %}

    <!-- Display this section only if there is no report data -->
    {% if not report_data %}
        <div class="messages info" style="margin-top:2rem;">
            No report data available. Please select a date range and filters, then generate the report.
        </div>
        <!-- Always show the table structure even if no data -->
        <div class="inventory-list" style="margin-top:2rem;">
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Description</th>
                        <th>Opening Stock</th>
                        <th>Purchases</th>
                        <th>Adjustment</th>
                        <th>HQ Issue</th>
                        <th>Jabi Issue</th>
                        <th>Closing Stock</th>
                        <th>Unit Price (₦)</th>
                        <th>Total Value (₦)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="10" style="text-align:center; color:#888;">No data for the selected filter.</td></tr>
                </tbody>
            </table>
        </div>
    {% endif %}
</div>

<script>
  // Wait for DOM to load before initializing Flatpickr
  document.addEventListener('DOMContentLoaded', function() {
    // Monthly picker (year and month only)
    flatpickr("#month", {
      plugins: [
        new monthSelectPlugin({
          shorthand: true,
          dateFormat: "Y-m",
          altFormat: "F Y"
        })
      ],
    });

    // Weekly picker (date range)
    flatpickr("#week_range", {
      mode: "range",
      dateFormat: "Y-m-d"
    });

    // Daily picker (single date)
    flatpickr("#day_date", {
      dateFormat: "Y-m-d"
    });

    function initializeTomSelect(selector) {
        new TomSelect(selector, {
            valueField: 'id',
            labelField: 'text',
            searchField: 'text',
            load: function(query, callback) {
                var url = '{{ url_for("reports.search_inventory") }}?q=' + encodeURIComponent(query);
                fetch(url)
                    .then(response => response.json())
                    .then(json => {
                        callback(json);
                    }).catch(()=>{
                        callback();
                    });
            },
            render: {
                option: function(data, escape) {
                    return '<div>' + escape(data.text) + '</div>';
                },
                item: function(data, escape) {
                    return '<div>' + escape(data.text) + '</div>';
                }
            }
        });
    }

    initializeTomSelect('#item_id_month');
    initializeTomSelect('#item_id_week');
    initializeTomSelect('#item_id_day');
  });
</script>
{% endblock %}
